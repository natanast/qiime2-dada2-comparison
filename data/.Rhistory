library(dada2)
library(ShortRead)
project_path <- "/mnt/c/Users/Aspasia/Desktop/Thesis ΕΚΕΤΑ/qiime2-dada2-comparison"
fastq_path <- file.path(project_path, "data/dada2_data/fastq_files")
silva_path <- file.path(project_path, "data/silva_nr99_v138.1_train_set.fa.gz")
fns <- list.files(fastq_path, pattern = ".fastq", full.names = TRUE)
print(paste("Found", length(fns), "FASTQ files"))
sample.names <- sapply(strsplit(basename(fns), "\\."), `[`, 1)
print("First few sample names:")
print(sample.names[1:5])
print("Inspecting read quality profiles...")
plotQualityProfile(fns[1:4]
print("Inspecting read quality profiles...")
plotQualityProfile(fns[1:4])
plotQualityProfile(fnFs[1:2])
plotQualityProfile(fns[1:4])
print("Step 1: Filtering and trimming forward reads...")
out <- filterAndTrim(fns, filtFs, truncLen = 120, maxN = 0, maxEE = 2, 
                     truncQ = 2, rm.phix = TRUE, compress = TRUE, multithread = TRUE)
print("Filtering results:")
print(out)
filt_path <- file.path(fastq_path, "filtered")
dir.create(filt_path, showWarnings = FALSE)
filtFs <- file.path(filt_path, paste0(sample.names, "_filt.fastq.gz"))

print("Step 1: Filtering and trimming forward reads...")
out <- filterAndTrim(fns, filtFs, truncLen = 120, maxN = 0, maxEE = 2, 
                     truncQ = 2, rm.phix = TRUE, compress = TRUE, multithread = TRUE)
print("Filtering results:")
print(out)
print("Step 2: Learning error rates...")
errF <- learnErrors(filtFs, multithread = TRUE)
plotErrors(errF, nominalQ=TRUE)
print("Step 3: Running DADA2 algorithm...")
dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
print("Step 4: Constructing sequence table...")
seqtab <- makeSequenceTable(dadaFs)
print(paste("Sequence table dimensions:", dim(seqtab)[1], "samples x", dim(seqtab)[2], "features"))
print("Checking sequence length distribution...")
table(nchar(getSequences(seqtab)))
print("Step 5: Removing chimeras...")
seqtab.nochim <- removeBimeraDenovo(seqtab, method = "consensus", multithread = TRUE, verbose = TRUE)
print(paste("Percentage of non-chimeric sequences:", round(sum(seqtab.nochim)/sum(seqtab)*100, 2), "%"))
print("Step 6: Assigning taxonomy...")
taxa <- assignTaxonomy(seqtab.nochim, silva_path, multithread = TRUE)
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)
print("Step 7: Saving taxonomy file...")
write.table(taxa, file.path(project_path, "data/dada2_data/dada2_taxonomy.tsv"), 
            sep = "\t", quote = FALSE, col.names = NA)

print("DADA2 analysis complete!")
print(paste("Taxonomy saved to:", file.path(project_path, "data/dada2_data/dada2_taxonomy.tsv")))
q()
